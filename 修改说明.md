# TPS Helper 积分系统修改说明

## 修改概述

本次修改将原有的"配额"系统全面升级为"积分"系统，实现了以下核心功能：

1. **术语统一**：所有界面和代码中的"配额"已更改为"积分"
2. **积分扣除逻辑**：提取新标签和导出CSV共用同一个积分池
3. **实时联动**：前后端积分数据实时同步

---

## 积分扣除规则

| 操作 | 扣除积分 | 说明 |
|------|----------|------|
| **提取新标签** | 每个标签 -1 积分 | 在 OPEN_URLS 时自动扣除 |
| **导出 CSV** | 每个号码 -1 积分 | 导出时按号码数量扣除 |

**示例**：
- 用户有 10000 积分
- 提取 100 个新标签 → 剩余 9900 积分
- 导出 500 个号码 → 剩余 9400 积分

---

## 修改的文件清单

### 后端 API（api 目录）

| 文件 | 修改内容 |
|------|----------|
| `auth.js` | 返回 `creditsInfo` 替代 `quotaInfo`，术语改为积分 |
| `export.js` | 新增 `deduct` action 用于提取标签时扣积分，`report` action 用于导出CSV时扣积分 |
| `admin.js` | 所有中文"配额"改为"积分" |

### Chrome 插件（extension 目录）

| 文件 | 修改内容 |
|------|----------|
| `auth.js` | 新增 `deductCredits()` 方法，`getCreditsInfo()` 替代 `getQuotaInfo()`，回调改为 `onCreditsUpdate` |
| `background.js` | `OPEN_URLS` 处理中添加积分扣除逻辑，积分不足时暂停任务 |
| `popup.html` | "配额信息"改为"积分信息"，元素ID从 `quota*` 改为 `credits*` |
| `popup.js` | `updateCreditsDisplay()` 替代 `updateQuotaDisplay()`，显示"个人积分"/"团队积分" |

### 管理后台

| 文件 | 修改内容 |
|------|----------|
| `admin.html` | 所有"配额"改为"积分"，包括表头、按钮、弹窗标题等 |

---

## API 接口变更

### 新增接口：积分扣除（提取标签时）

```
POST /api/export?action=deduct
Content-Type: application/json

{
  "username": "用户名",
  "token": "登录Token",
  "count": 10  // 要扣除的积分数量
}
```

**响应示例**：
```json
{
  "ok": true,
  "msg": "积分已扣除",
  "userUsedCount": 150,
  "deductedCount": 10,
  "remaining": 850,
  "source": "extract"
}
```

### 修改接口：导出上报（导出CSV时）

```
POST /api/export?action=report
Content-Type: application/json

{
  "username": "用户名",
  "token": "登录Token",
  "count": 100  // 导出的号码数量
}
```

**响应示例**：
```json
{
  "ok": true,
  "msg": "导出记录已上报",
  "userUsedCount": 250,
  "deductedCount": 100,
  "remaining": 750,
  "source": "export"
}
```

### 积分不足时的响应

```json
{
  "ok": false,
  "msg": "积分已用完（10000），如需继续使用请联系管理员",
  "code": "CREDITS_EXCEEDED",
  "creditsInfo": {
    "type": "personal",
    "credits": 10000,
    "used": 10001
  }
}
```

---

## 积分信息数据结构

### 个人积分

```json
{
  "type": "personal",
  "credits": 10000,
  "used": 150,
  "remaining": 9850
}
```

### 团队积分

```json
{
  "type": "line",
  "lineName": "A1",
  "credits": 100000,
  "used": 5000,
  "remaining": 95000
}
```

---

## 部署说明

### 1. 部署后端 API

1. 将 `api_modified.zip` 解压到 Vercel 项目的 `api` 目录
2. 确保 `admin.html`、`package.json`、`vercel.json` 在项目根目录
3. 推送到 GitHub 触发 Vercel 自动部署

### 2. 更新 Chrome 插件

1. 将 `extension_modified.zip` 解压
2. 在 Chrome 扩展管理页面重新加载插件
3. 或打包为 `.crx` 文件分发

---

## 兼容性说明

- 保留了 `getQuotaInfo()` 作为 `getCreditsInfo()` 的别名
- 保留了 `onQuotaUpdate` 作为 `onCreditsUpdate` 的 setter
- 保留了 `updateQuotaDisplay()` 作为 `updateCreditsDisplay()` 的包装函数
- 服务器返回的 `creditsInfo` 同时包含 `credits` 和 `quota` 字段（兼容旧版）

---

## 注意事项

1. **积分用完后**：用户账号会被自动锁定（status: 'locked'），需要管理员在后台增加积分后解锁
2. **实时同步**：插件每 10 秒检查一次账户状态，每 30 秒刷新一次积分信息
3. **网络异常**：如果积分扣除请求失败（网络问题），任务会继续执行但会记录警告日志
