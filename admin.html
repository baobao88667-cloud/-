<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TPS Helper ç®¡ç†åå°</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      min-height: 100vh; color: #e0e0e0;
    }
    .container { max-width: 1600px; margin: 0 auto; padding: 20px; }
    header {
      display: flex; justify-content: space-between; align-items: center;
      padding: 20px 0; border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 30px;
    }
    h1 { font-size: 24px; background: linear-gradient(90deg, #00d9ff, #00ff88); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .stats-bar { display: flex; gap: 20px; font-size: 14px; }
    .stat-item { display: flex; align-items: center; gap: 8px; }
    .stat-value { color: #00d9ff; font-weight: bold; }
    .tabs { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
    .tab { padding: 10px 20px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; cursor: pointer; transition: all 0.3s; }
    .tab:hover { background: rgba(255,255,255,0.1); }
    .tab.active { background: linear-gradient(135deg, #00d9ff33, #00ff8833); border-color: #00d9ff; }
    .panel { display: none; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 20px; }
    .panel.active { display: block; }
    .section { margin-bottom: 30px; }
    .section-title { font-size: 16px; color: #00d9ff; margin-bottom: 15px; display: flex; align-items: center; gap: 8px; }
    .form-row { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; align-items: center; }
    input, select, textarea { padding: 10px 15px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2); border-radius: 6px; color: #fff; font-size: 14px; }
    input:focus, select:focus, textarea:focus { outline: none; border-color: #00d9ff; }
    input::placeholder { color: rgba(255,255,255,0.4); }
    button { padding: 10px 20px; background: linear-gradient(135deg, #00d9ff, #00ff88); border: none; border-radius: 6px; color: #000; font-weight: bold; cursor: pointer; transition: all 0.3s; }
    button:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(0,217,255,0.3); }
    button.danger { background: linear-gradient(135deg, #ff4757, #ff6b81); }
    button.warning { background: linear-gradient(135deg, #ffa502, #ff7f50); }
    button.secondary { background: rgba(255,255,255,0.1); color: #fff; }
    button:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 12px; text-align: left; border-bottom: 1px solid rgba(255,255,255,0.1); }
    th { color: #00d9ff; font-weight: 500; }
    tr:hover { background: rgba(255,255,255,0.03); }
    .badge { display: inline-block; padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: 500; }
    .badge.success { background: rgba(0,255,136,0.2); color: #00ff88; }
    .badge.warning { background: rgba(255,165,2,0.2); color: #ffa502; }
    .badge.danger { background: rgba(255,71,87,0.2); color: #ff4757; }
    .badge.info { background: rgba(0,217,255,0.2); color: #00d9ff; }
    .action-btns { display: flex; gap: 5px; flex-wrap: wrap; }
    .action-btns button { padding: 5px 10px; font-size: 12px; }
    .toggle-switch { position: relative; width: 50px; height: 26px; }
    .toggle-switch input { opacity: 0; width: 0; height: 0; }
    .toggle-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255,255,255,0.1); border-radius: 26px; transition: 0.3s; }
    .toggle-slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 3px; bottom: 3px; background: #fff; border-radius: 50%; transition: 0.3s; }
    .toggle-switch input:checked + .toggle-slider { background: linear-gradient(135deg, #00d9ff, #00ff88); }
    .toggle-switch input:checked + .toggle-slider:before { transform: translateX(24px); }
    .progress-bar { width: 100%; height: 8px; background: rgba(255,255,255,0.1); border-radius: 4px; overflow: hidden; }
    .progress-fill { height: 100%; background: linear-gradient(90deg, #00d9ff, #00ff88); border-radius: 4px; transition: width 0.3s; }
    .progress-fill.warning { background: linear-gradient(90deg, #ffa502, #ff7f50); }
    .progress-fill.danger { background: linear-gradient(90deg, #ff4757, #ff6b81); }
    .card { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 15px; margin-bottom: 15px; }
    .card-title { font-size: 14px; color: #888; margin-bottom: 10px; }
    .card-value { font-size: 28px; font-weight: bold; color: #00d9ff; }
    .grid-3 { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center; }
    .modal.active { display: flex; }
    .modal-content { background: #1a1a2e; border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 30px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; }
    .modal-title { font-size: 18px; margin-bottom: 20px; color: #00d9ff; }
    .modal-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; }
    .loading { text-align: center; padding: 40px; color: #888; }
    .empty { text-align: center; padding: 40px; color: #666; }
    .batch-bar { display: none; background: rgba(0,217,255,0.1); border: 1px solid rgba(0,217,255,0.3); border-radius: 8px; padding: 15px; margin-bottom: 15px; align-items: center; gap: 15px; flex-wrap: wrap; }
    .batch-bar.active { display: flex; }
    .batch-bar .selected-count { color: #00d9ff; font-weight: bold; }
    .checkbox-cell { width: 40px; }
    input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; }
    .password-cell { font-family: monospace; color: #ffa502; }
    .password-hidden { color: #666; cursor: pointer; }
    .password-hidden:hover { color: #00d9ff; }
    .quota-info { font-size: 12px; color: #888; }
    .quota-info.personal { color: #00ff88; }
    .quota-info.shared { color: #00d9ff; }
    .team-card { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 20px; margin-bottom: 20px; }
    .team-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
    .team-name { font-size: 18px; font-weight: bold; color: #00d9ff; }
    .team-stats { display: flex; gap: 20px; margin-bottom: 15px; }
    .team-stat { text-align: center; }
    .team-stat-value { font-size: 24px; font-weight: bold; }
    .team-stat-label { font-size: 12px; color: #888; }
    .team-users { max-height: 200px; overflow-y: auto; }
    @media (max-width: 768px) {
      .stats-bar { display: none; }
      .form-row { flex-direction: column; }
      input, select, button { width: 100%; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>ğŸ›¡ï¸ TPS Helper ç®¡ç†åå°</h1>
      <div class="stats-bar">
        <div class="stat-item"><span>åœ¨çº¿ç”¨æˆ·:</span><span class="stat-value" id="onlineCount">-</span></div>
        <div class="stat-item"><span>å¾…å®¡æ ¸:</span><span class="stat-value" id="pendingCount">-</span></div>
        <div class="stat-item"><span>æ€»å¯¼å‡º:</span><span class="stat-value" id="totalExports">-</span></div>
      </div>
    </header>
    <div class="tabs">
      <div class="tab active" data-tab="dashboard">ğŸ“Š ä»ªè¡¨ç›˜</div>
      <div class="tab" data-tab="teams">ğŸ¢ å›¢é˜Ÿç®¡ç†</div>
      <div class="tab" data-tab="users">ğŸ‘¥ ç”¨æˆ·ç®¡ç†</div>
      <div class="tab" data-tab="pending">â³ å¾…å®¡æ ¸</div>
      <div class="tab" data-tab="system">âš™ï¸ ç³»ç»Ÿæ§åˆ¶</div>
    </div>

    <!-- ä»ªè¡¨ç›˜ -->
    <div class="panel active" id="panel-dashboard">
      <div class="grid-3" id="statsCards">
        <div class="card"><div class="card-title">æ€»ç”¨æˆ·æ•°</div><div class="card-value" id="stat-totalUsers">-</div></div>
        <div class="card"><div class="card-title">æ´»è·ƒç”¨æˆ·</div><div class="card-value" id="stat-activeUsers">-</div></div>
        <div class="card"><div class="card-title">åœ¨çº¿ç”¨æˆ·</div><div class="card-value" id="stat-onlineUsers">-</div></div>
        <div class="card"><div class="card-title">å¾…å®¡æ ¸</div><div class="card-value" id="stat-pendingUsers">-</div></div>
        <div class="card"><div class="card-title">å·²é”å®š</div><div class="card-value" id="stat-lockedUsers">-</div></div>
        <div class="card"><div class="card-title">æ€»å¯¼å‡ºæ•°</div><div class="card-value" id="stat-totalExports">-</div></div>
      </div>
      <div class="section">
        <div class="section-title">ğŸ“¡ å›¢é˜Ÿ/çº¿è·¯é…é¢ä½¿ç”¨æƒ…å†µ</div>
        <div id="lineStats"><div class="loading">åŠ è½½ä¸­...</div></div>
      </div>
    </div>

    <!-- å›¢é˜Ÿç®¡ç† -->
    <div class="panel" id="panel-teams">
      <div class="section">
        <div class="section-title">â• åˆ›å»ºå›¢é˜Ÿ/çº¿è·¯</div>
        <div class="form-row">
          <input type="text" id="newLineName" placeholder="å›¢é˜Ÿåç§°ï¼ˆå¦‚ï¼šAå›¢é˜Ÿï¼‰">
          <input type="number" id="newLineQuota" placeholder="æ€»é…é¢ï¼ˆ0=æ— é™åˆ¶ï¼‰" min="0">
          <select id="newLineMode">
            <option value="shared">å…±äº«æ¨¡å¼ï¼ˆå›¢é˜Ÿå…±ç”¨é…é¢ï¼‰</option>
            <option value="split">å¹³æ‘Šæ¨¡å¼ï¼ˆé…é¢å¹³åˆ†ç»™æˆå‘˜ï¼‰</option>
          </select>
          <button onclick="addLine()">åˆ›å»ºå›¢é˜Ÿ</button>
        </div>
      </div>
      <div class="section">
        <div class="section-title">ğŸ¢ å›¢é˜Ÿåˆ—è¡¨</div>
        <div id="teamList"><div class="loading">åŠ è½½ä¸­...</div></div>
      </div>
    </div>

    <!-- ç”¨æˆ·ç®¡ç† -->
    <div class="panel" id="panel-users">
      <div class="section">
        <div class="section-title">ğŸ‘¥ ç”¨æˆ·åˆ—è¡¨</div>
        <div class="form-row">
          <input type="text" id="userSearch" placeholder="æœç´¢ç”¨æˆ·å...">
          <select id="userFilter">
            <option value="">å…¨éƒ¨çŠ¶æ€</option>
            <option value="approved">æ­£å¸¸</option>
            <option value="disabled">å·²ç¦ç”¨</option>
            <option value="locked">å·²é”å®š</option>
          </select>
          <select id="lineFilter"><option value="">å…¨éƒ¨å›¢é˜Ÿ</option></select>
          <label style="display: flex; align-items: center; gap: 5px; cursor: pointer;">
            <input type="checkbox" id="showPasswords" onchange="renderUsers()"><span>æ˜¾ç¤ºå¯†ç </span>
          </label>
          <button onclick="loadUsers()">ğŸ”„ åˆ·æ–°</button>
        </div>
        <div class="batch-bar" id="batchBar">
          <span>å·²é€‰æ‹© <span class="selected-count" id="selectedCount">0</span> ä¸ªç”¨æˆ·</span>
          <select id="batchLine"><option value="">é€‰æ‹©å›¢é˜Ÿ...</option></select>
          <button onclick="batchSetLine()">æ‰¹é‡è®¾ç½®å›¢é˜Ÿ</button>
          <input type="number" id="batchExpireDays" placeholder="æœ‰æ•ˆæœŸ(å¤©)" style="width:100px;">
          <button onclick="batchSetExpire()">æ‰¹é‡è®¾ç½®æœ‰æ•ˆæœŸ</button>
          <input type="number" id="batchPersonalQuota" placeholder="ä¸ªäººé…é¢" style="width:100px;">
          <button onclick="batchSetPersonalQuota()">æ‰¹é‡è®¾ç½®é…é¢</button>
          <button class="warning" onclick="batchResetExport()">æ‰¹é‡é‡ç½®å¯¼å‡ºæ•°</button>
          <button class="secondary" onclick="clearSelection()">å–æ¶ˆé€‰æ‹©</button>
        </div>
        <div style="overflow-x: auto;">
          <table>
            <thead>
              <tr>
                <th class="checkbox-cell"><input type="checkbox" id="selectAll" onchange="toggleSelectAll()"></th>
                <th>ç”¨æˆ·å</th>
                <th>å¯†ç </th>
                <th>çŠ¶æ€</th>
                <th>å›¢é˜Ÿ</th>
                <th>å¯¼å‡ºæ•°/é…é¢</th>
                <th>æœ‰æ•ˆæœŸ</th>
                <th>æ“ä½œ</th>
              </tr>
            </thead>
            <tbody id="userTable"><tr><td colspan="8" class="loading">åŠ è½½ä¸­...</td></tr></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- å¾…å®¡æ ¸ -->
    <div class="panel" id="panel-pending">
      <div class="section">
        <div class="section-title">â³ å¾…å®¡æ ¸ç”¨æˆ·</div>
        <div id="pendingList"><div class="loading">åŠ è½½ä¸­...</div></div>
      </div>
    </div>

    <!-- ç³»ç»Ÿæ§åˆ¶ -->
    <div class="panel" id="panel-system">
      <div class="section">
        <div class="section-title">ğŸ”§ ç»´æŠ¤æ¨¡å¼</div>
        <div class="form-row">
          <span>ç»´æŠ¤æ¨¡å¼ï¼š</span>
          <label class="toggle-switch"><input type="checkbox" id="maintenanceToggle" onchange="toggleMaintenance()"><span class="toggle-slider"></span></label>
        </div>
        <div class="form-row">
          <input type="text" id="maintenanceMsg" placeholder="ç»´æŠ¤æç¤ºè¯­" style="flex: 1;">
          <button onclick="saveMaintenanceMsg()">ä¿å­˜æç¤ºè¯­</button>
        </div>
      </div>
      <div class="section">
        <div class="section-title">ğŸ“¢ å…¬å‘Šè®¾ç½®</div>
        <div class="form-row">
          <span>å¯ç”¨å…¬å‘Šï¼š</span>
          <label class="toggle-switch"><input type="checkbox" id="announcementToggle" onchange="toggleAnnouncement()"><span class="toggle-slider"></span></label>
        </div>
        <div class="form-row"><textarea id="announcementText" placeholder="å…¬å‘Šå†…å®¹" style="flex: 1; min-height: 80px;"></textarea></div>
        <div class="form-row"><button onclick="saveAnnouncement()">ä¿å­˜å…¬å‘Š</button></div>
      </div>
      <div class="section">
        <div class="section-title">ğŸš¨ ç´§æ€¥æ“ä½œ</div>
        <div class="form-row"><button class="danger" onclick="kickAllUsers()">ğŸš« ä¸€é”®è¸¢å‡ºæ‰€æœ‰ç”¨æˆ·</button></div>
        <p style="color: #888; font-size: 12px; margin-top: 10px;">æ­¤æ“ä½œå°†ä½¿æ‰€æœ‰ç”¨æˆ·çš„ç™»å½•å¤±æ•ˆï¼Œéœ€è¦é‡æ–°ç™»å½•ã€‚</p>
      </div>
    </div>
  </div>

  <!-- å®¡æ ¸å¼¹çª— -->
  <div class="modal" id="approveModal">
    <div class="modal-content">
      <div class="modal-title">å®¡æ ¸ç”¨æˆ·: <span id="approveUsername"></span></div>
      <div class="form-row"><label>åˆ†é…å›¢é˜Ÿï¼š</label><select id="approveLine" style="flex: 1;"><option value="">ä¸åˆ†é…å›¢é˜Ÿ</option></select></div>
      <div class="form-row"><label>æœ‰æ•ˆæœŸï¼š</label><input type="number" id="approveExpireDays" placeholder="å¤©æ•°ï¼Œ0=æ°¸ä¹…" min="0" style="flex: 1;"></div>
      <div class="form-row"><label>ä¸ªäººé…é¢ï¼š</label><input type="number" id="approvePersonalQuota" placeholder="0=è·Ÿéšå›¢é˜Ÿ" min="0" style="flex: 1;"></div>
      <div class="modal-actions">
        <button class="secondary" onclick="closeModal('approveModal')">å–æ¶ˆ</button>
        <button class="danger" onclick="rejectUser()">æ‹’ç»</button>
        <button onclick="approveUser()">é€šè¿‡</button>
      </div>
    </div>
  </div>

  <!-- ç”¨æˆ·è¯¦æƒ…å¼¹çª— -->
  <div class="modal" id="userModal">
    <div class="modal-content">
      <div class="modal-title">ç”¨æˆ·è¯¦æƒ…: <span id="modalUsername"></span></div>
      <div id="userDetails"></div>
      <div class="modal-actions"><button class="secondary" onclick="closeModal('userModal')">å…³é—­</button></div>
    </div>
  </div>

  <!-- å›¢é˜Ÿé…é¢è®¾ç½®å¼¹çª— -->
  <div class="modal" id="teamQuotaModal">
    <div class="modal-content">
      <div class="modal-title">è®¾ç½®å›¢é˜Ÿé…é¢: <span id="teamQuotaName"></span></div>
      <div class="form-row">
        <label>é…é¢æ¨¡å¼ï¼š</label>
        <select id="teamQuotaMode" style="flex: 1;">
          <option value="shared">å…±äº«æ¨¡å¼ï¼ˆå›¢é˜Ÿå…±ç”¨é…é¢ï¼‰</option>
          <option value="split">å¹³æ‘Šæ¨¡å¼ï¼ˆé…é¢å¹³åˆ†ç»™æˆå‘˜ï¼‰</option>
        </select>
      </div>
      <div class="form-row">
        <label>æ€»é…é¢ï¼š</label>
        <input type="number" id="teamQuotaValue" placeholder="0=æ— é™åˆ¶" min="0" style="flex: 1;">
      </div>
      <p style="color: #888; font-size: 12px; margin: 10px 0;">
        å…±äº«æ¨¡å¼ï¼šå›¢é˜Ÿæ‰€æœ‰æˆå‘˜å…±ç”¨æ€»é…é¢<br>
        å¹³æ‘Šæ¨¡å¼ï¼šæ€»é…é¢å¹³å‡åˆ†é…ç»™æ¯ä¸ªæˆå‘˜ä½œä¸ºä¸ªäººé…é¢
      </p>
      <div class="modal-actions">
        <button class="secondary" onclick="closeModal('teamQuotaModal')">å–æ¶ˆ</button>
        <button onclick="saveTeamQuota()">ä¿å­˜</button>
      </div>
    </div>
  </div>

  <!-- å¯¼å‡ºå†å²å¼¹çª— -->
  <div class="modal" id="historyModal">
    <div class="modal-content" style="max-width: 700px;">
      <div class="modal-title">å¯¼å‡ºå†å²: <span id="historyUsername"></span></div>
      <div id="historyContent"></div>
      <div class="modal-actions"><button class="secondary" onclick="closeModal('historyModal')">å…³é—­</button></div>
    </div>
  </div>

  <script>
    const API_BASE = window.location.origin;
    let allUsers = [];
    let allLines = [];
    let selectedUsers = new Set();
    
    document.addEventListener('DOMContentLoaded', () => {
      initTabs();
      loadStats();
      loadUsers();
      loadLines();
      loadPending();
      loadSystemConfig();
      setInterval(loadStats, 30000);
    });
    
    function initTabs() {
      document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', () => {
          document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
          document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
          tab.classList.add('active');
          document.getElementById('panel-' + tab.dataset.tab).classList.add('active');
        });
      });
    }
    
    async function loadStats() {
      try {
        const res = await fetch(`${API_BASE}/api/system/stats`);
        const data = await res.json();
        if (data.ok) {
          const s = data.stats;
          document.getElementById('onlineCount').textContent = s.users.online;
          document.getElementById('pendingCount').textContent = s.users.pending;
          document.getElementById('totalExports').textContent = s.exports.total.toLocaleString();
          document.getElementById('stat-totalUsers').textContent = s.users.total;
          document.getElementById('stat-activeUsers').textContent = s.users.active;
          document.getElementById('stat-onlineUsers').textContent = s.users.online;
          document.getElementById('stat-pendingUsers').textContent = s.users.pending;
          document.getElementById('stat-lockedUsers').textContent = s.users.locked;
          document.getElementById('stat-totalExports').textContent = s.exports.total.toLocaleString();
          let lineHtml = '';
          for (const line of s.lines) {
            const percent = line.quota > 0 ? Math.min(100, (line.used / line.quota) * 100) : 0;
            const colorClass = percent >= 90 ? 'danger' : percent >= 70 ? 'warning' : '';
            lineHtml += `<div class="card"><div class="card-title">${line.name}</div><div style="margin-bottom: 10px;"><span style="font-size: 20px; font-weight: bold;">${line.used.toLocaleString()}</span><span style="color: #888;"> / ${line.quota > 0 ? line.quota.toLocaleString() : 'æ— é™åˆ¶'}</span></div>${line.quota > 0 ? `<div class="progress-bar"><div class="progress-fill ${colorClass}" style="width: ${percent}%"></div></div>` : ''}</div>`;
          }
          document.getElementById('lineStats').innerHTML = lineHtml || '<div class="empty">æš‚æ— å›¢é˜Ÿ</div>';
        }
      } catch (e) { console.error('Load stats error:', e); }
    }
    
    async function loadUsers() {
      try {
        const res = await fetch(`${API_BASE}/api/admin/users`);
        const data = await res.json();
        if (data.ok) { allUsers = data.users; renderUsers(); }
      } catch (e) { console.error('Load users error:', e); }
    }
    
    function renderUsers() {
      const search = document.getElementById('userSearch').value.toLowerCase();
      const statusFilter = document.getElementById('userFilter').value;
      const lineFilter = document.getElementById('lineFilter').value;
      const showPasswords = document.getElementById('showPasswords').checked;
      let filtered = allUsers.filter(u => {
        if (u.status === 'pending') return false;
        if (search && !u.name.toLowerCase().includes(search)) return false;
        if (statusFilter && u.status !== statusFilter) return false;
        if (lineFilter && u.line !== lineFilter) return false;
        return true;
      });
      if (filtered.length === 0) {
        document.getElementById('userTable').innerHTML = '<tr><td colspan="8" class="empty">æš‚æ— ç”¨æˆ·</td></tr>';
        updateBatchBar();
        return;
      }
      let html = '';
      const now = Date.now();
      for (const user of filtered) {
        const isExpired = user.expireAt > 0 && now > user.expireAt;
        let statusBadge = '';
        if (user.status === 'disabled' || !user.enabled) statusBadge = '<span class="badge danger">å·²ç¦ç”¨</span>';
        else if (user.status === 'locked') statusBadge = '<span class="badge danger">å·²é”å®š</span>';
        else if (isExpired) statusBadge = '<span class="badge warning">å·²è¿‡æœŸ</span>';
        else statusBadge = '<span class="badge success">æ­£å¸¸</span>';
        const expireText = user.expireAt > 0 ? new Date(user.expireAt).toLocaleDateString() : 'æ°¸ä¹…';
        const isSelected = selectedUsers.has(user.name);
        const pwd = user.password || '';
        const passwordDisplay = showPasswords ? `<span class="password-cell">${pwd}</span>` : `<span class="password-hidden" onclick="copyPassword('${user.name}', '${pwd}')" title="ç‚¹å‡»å¤åˆ¶">â€¢â€¢â€¢â€¢â€¢â€¢</span>`;
        // é…é¢æ˜¾ç¤º
        let quotaDisplay = '';
        if (user.personalQuota > 0) {
          quotaDisplay = `<span class="quota-info personal">${user.exportCount.toLocaleString()} / ${user.personalQuota.toLocaleString()} (ä¸ªäºº)</span>`;
        } else if (user.line) {
          const lineData = allLines.find(l => l.name === user.line);
          if (lineData && lineData.quota > 0) {
            quotaDisplay = `<span class="quota-info shared">${user.exportCount.toLocaleString()} (å›¢é˜Ÿå…±äº«)</span>`;
          } else {
            quotaDisplay = `${user.exportCount.toLocaleString()} (æ— é™åˆ¶)`;
          }
        } else {
          quotaDisplay = `${user.exportCount.toLocaleString()} (æ— é™åˆ¶)`;
        }
        html += `<tr>
          <td class="checkbox-cell"><input type="checkbox" ${isSelected ? 'checked' : ''} onchange="toggleUserSelect('${user.name}')"></td>
          <td>${user.name}</td>
          <td>${passwordDisplay}</td>
          <td>${statusBadge}</td>
          <td>${user.line || '-'}</td>
          <td>${quotaDisplay}</td>
          <td>${expireText}</td>
          <td><div class="action-btns">
            <button class="secondary" onclick="showUserDetail('${user.name}')">è¯¦æƒ…</button>
            <button class="secondary" onclick="showHistory('${user.name}')">å†å²</button>
            ${user.enabled ? `<button class="warning" onclick="toggleUser('${user.name}', false)">ç¦ç”¨</button>` : `<button onclick="toggleUser('${user.name}', true)">å¯ç”¨</button>`}
            <button class="warning" onclick="kickUser('${user.name}')">è¸¢å‡º</button>
            <button class="danger" onclick="removeUser('${user.name}')">åˆ é™¤</button>
          </div></td>
        </tr>`;
      }
      document.getElementById('userTable').innerHTML = html;
      updateBatchBar();
    }
    
    function copyPassword(username, password) { if (password) navigator.clipboard.writeText(password).then(() => alert(`å·²å¤åˆ¶ ${username} çš„å¯†ç `)); }
    function toggleUserSelect(username) { if (selectedUsers.has(username)) selectedUsers.delete(username); else selectedUsers.add(username); updateBatchBar(); renderUsers(); }
    function toggleSelectAll() {
      const selectAll = document.getElementById('selectAll').checked;
      const search = document.getElementById('userSearch').value.toLowerCase();
      const statusFilter = document.getElementById('userFilter').value;
      const lineFilter = document.getElementById('lineFilter').value;
      let filtered = allUsers.filter(u => {
        if (u.status === 'pending') return false;
        if (search && !u.name.toLowerCase().includes(search)) return false;
        if (statusFilter && u.status !== statusFilter) return false;
        if (lineFilter && u.line !== lineFilter) return false;
        return true;
      });
      if (selectAll) filtered.forEach(u => selectedUsers.add(u.name));
      else filtered.forEach(u => selectedUsers.delete(u.name));
      renderUsers();
    }
    function clearSelection() { selectedUsers.clear(); document.getElementById('selectAll').checked = false; renderUsers(); }
    function updateBatchBar() {
      const batchBar = document.getElementById('batchBar');
      const count = selectedUsers.size;
      if (count > 0) { batchBar.classList.add('active'); document.getElementById('selectedCount').textContent = count; }
      else batchBar.classList.remove('active');
    }
    
    // æ‰¹é‡æ“ä½œ
    async function batchSetLine() {
      const line = document.getElementById('batchLine').value;
      if (selectedUsers.size === 0) { alert('è¯·å…ˆé€‰æ‹©ç”¨æˆ·'); return; }
      if (!line && !confirm('æœªé€‰æ‹©å›¢é˜Ÿï¼Œå°†ç§»é™¤æ‰€é€‰ç”¨æˆ·çš„å›¢é˜Ÿåˆ†é…ï¼Œç¡®å®šç»§ç»­ï¼Ÿ')) return;
      try {
        const res = await fetch(`${API_BASE}/api/admin/batchSetLine`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ usernames: Array.from(selectedUsers), line: line }) });
        const data = await res.json();
        alert(data.msg);
        if (data.ok) { clearSelection(); loadUsers(); loadLines(); }
      } catch (e) { alert('æ“ä½œå¤±è´¥'); }
    }
    async function batchSetExpire() {
      const days = parseInt(document.getElementById('batchExpireDays').value);
      if (selectedUsers.size === 0) { alert('è¯·å…ˆé€‰æ‹©ç”¨æˆ·'); return; }
      if (isNaN(days)) { alert('è¯·è¾“å…¥æœ‰æ•ˆæœŸå¤©æ•°'); return; }
      try {
        const res = await fetch(`${API_BASE}/api/admin/batchSetExpire`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ usernames: Array.from(selectedUsers), expireDays: days }) });
        const data = await res.json();
        alert(data.msg);
        if (data.ok) { clearSelection(); loadUsers(); }
      } catch (e) { alert('æ“ä½œå¤±è´¥'); }
    }
    async function batchSetPersonalQuota() {
      const quota = parseInt(document.getElementById('batchPersonalQuota').value);
      if (selectedUsers.size === 0) { alert('è¯·å…ˆé€‰æ‹©ç”¨æˆ·'); return; }
      if (isNaN(quota)) { alert('è¯·è¾“å…¥é…é¢æ•°é‡'); return; }
      try {
        const res = await fetch(`${API_BASE}/api/admin/batchSetQuota`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ usernames: Array.from(selectedUsers), personalQuota: quota }) });
        const data = await res.json();
        alert(data.msg);
        if (data.ok) { clearSelection(); loadUsers(); }
      } catch (e) { alert('æ“ä½œå¤±è´¥'); }
    }
    async function batchResetExport() {
      if (selectedUsers.size === 0) { alert('è¯·å…ˆé€‰æ‹©ç”¨æˆ·'); return; }
      if (!confirm(`ç¡®å®šè¦é‡ç½® ${selectedUsers.size} ä¸ªç”¨æˆ·çš„å¯¼å‡ºæ•°é‡å—ï¼Ÿ`)) return;
      try {
        const res = await fetch(`${API_BASE}/api/admin/batchResetExport`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ usernames: Array.from(selectedUsers) }) });
        const data = await res.json();
        alert(data.msg);
        if (data.ok) { clearSelection(); loadUsers(); loadLines(); }
      } catch (e) { alert('æ“ä½œå¤±è´¥'); }
    }
    
    document.getElementById('userSearch')?.addEventListener('input', renderUsers);
    document.getElementById('userFilter')?.addEventListener('change', renderUsers);
    document.getElementById('lineFilter')?.addEventListener('change', renderUsers);
    
    // å›¢é˜Ÿ/çº¿è·¯ç®¡ç†
    async function loadLines() {
      try {
        const res = await fetch(`${API_BASE}/api/admin/lines`);
        const data = await res.json();
        if (data.ok) { allLines = data.lines; renderTeams(); updateLineFilters(); }
      } catch (e) { console.error('Load lines error:', e); }
    }
    
    function renderTeams() {
      if (allLines.length === 0) { document.getElementById('teamList').innerHTML = '<div class="empty">æš‚æ— å›¢é˜Ÿï¼Œè¯·å…ˆåˆ›å»º</div>'; return; }
      let html = '';
      for (const line of allLines) {
        const percent = line.quota > 0 ? Math.min(100, (line.used / line.quota) * 100) : 0;
        const colorClass = percent >= 90 ? 'danger' : percent >= 70 ? 'warning' : '';
        const modeText = line.quotaMode === 'split' ? 'å¹³æ‘Šæ¨¡å¼' : 'å…±äº«æ¨¡å¼';
        const modeBadge = line.quotaMode === 'split' ? '<span class="badge info">å¹³æ‘Š</span>' : '<span class="badge success">å…±äº«</span>';
        html += `<div class="team-card">
          <div class="team-header">
            <div class="team-name">${line.name} ${modeBadge}</div>
            <div class="action-btns">
              <button class="secondary" onclick="showTeamQuotaModal('${line.name}', '${line.quotaMode}', ${line.quota})">è®¾ç½®é…é¢</button>
              <button class="warning" onclick="resetTeamUsage('${line.name}')">é‡ç½®ç”¨é‡</button>
              <button class="danger" onclick="removeLine('${line.name}')">åˆ é™¤å›¢é˜Ÿ</button>
            </div>
          </div>
          <div class="team-stats">
            <div class="team-stat"><div class="team-stat-value">${line.userCount}</div><div class="team-stat-label">æˆå‘˜æ•°</div></div>
            <div class="team-stat"><div class="team-stat-value">${line.used.toLocaleString()}</div><div class="team-stat-label">å·²ç”¨é‡</div></div>
            <div class="team-stat"><div class="team-stat-value">${line.quota > 0 ? line.quota.toLocaleString() : 'æ— é™åˆ¶'}</div><div class="team-stat-label">æ€»é…é¢</div></div>
            <div class="team-stat"><div class="team-stat-value">${line.quota > 0 ? percent.toFixed(1) + '%' : '-'}</div><div class="team-stat-label">ä½¿ç”¨ç‡</div></div>
          </div>
          ${line.quota > 0 ? `<div class="progress-bar" style="margin-bottom: 15px;"><div class="progress-fill ${colorClass}" style="width: ${percent}%"></div></div>` : ''}
          <div class="section-title" style="font-size: 14px;">æˆå‘˜åˆ—è¡¨</div>
          <div class="team-users">
            ${line.users && line.users.length > 0 ? `<table><thead><tr><th>ç”¨æˆ·å</th><th>å¯¼å‡ºæ•°</th><th>ä¸ªäººé…é¢</th><th>çŠ¶æ€</th></tr></thead><tbody>
              ${line.users.map(u => `<tr><td>${u.name}</td><td>${u.exportCount.toLocaleString()}</td><td>${u.personalQuota > 0 ? u.personalQuota.toLocaleString() : 'è·Ÿéšå›¢é˜Ÿ'}</td><td>${u.status === 'approved' ? '<span class="badge success">æ­£å¸¸</span>' : u.status === 'locked' ? '<span class="badge danger">å·²é”å®š</span>' : '<span class="badge warning">' + u.status + '</span>'}</td></tr>`).join('')}
            </tbody></table>` : '<div class="empty" style="padding: 20px;">æš‚æ— æˆå‘˜</div>'}
          </div>
        </div>`;
      }
      document.getElementById('teamList').innerHTML = html;
    }
    
    function updateLineFilters() {
      const options = '<option value="">å…¨éƒ¨å›¢é˜Ÿ</option>' + allLines.map(l => `<option value="${l.name}">${l.name}</option>`).join('');
      document.getElementById('lineFilter').innerHTML = options;
      document.getElementById('batchLine').innerHTML = '<option value="">é€‰æ‹©å›¢é˜Ÿ...</option>' + allLines.map(l => `<option value="${l.name}">${l.name}</option>`).join('');
      document.getElementById('approveLine').innerHTML = '<option value="">ä¸åˆ†é…å›¢é˜Ÿ</option>' + allLines.map(l => `<option value="${l.name}">${l.name}</option>`).join('');
    }
    
    async function addLine() {
      const name = document.getElementById('newLineName').value.trim();
      const quota = parseInt(document.getElementById('newLineQuota').value) || 0;
      const mode = document.getElementById('newLineMode').value;
      if (!name) { alert('è¯·è¾“å…¥å›¢é˜Ÿåç§°'); return; }
      try {
        const res = await fetch(`${API_BASE}/api/admin/addLine`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name, quota, quotaMode: mode }) });
        const data = await res.json();
        alert(data.msg);
        if (data.ok) { document.getElementById('newLineName').value = ''; document.getElementById('newLineQuota').value = ''; loadLines(); }
      } catch (e) { alert('æ“ä½œå¤±è´¥'); }
    }
    
    function showTeamQuotaModal(name, mode, quota) {
      document.getElementById('teamQuotaName').textContent = name;
      document.getElementById('teamQuotaMode').value = mode || 'shared';
      document.getElementById('teamQuotaValue').value = quota || '';
      document.getElementById('teamQuotaModal').classList.add('active');
    }
    
    async function saveTeamQuota() {
      const name = document.getElementById('teamQuotaName').textContent;
      const mode = document.getElementById('teamQuotaMode').value;
      const quota = parseInt(document.getElementById('teamQuotaValue').value) || 0;
      try {
        const res = await fetch(`${API_BASE}/api/admin/batchSetQuota`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ line: name, totalQuota: quota, mode: mode }) });
        const data = await res.json();
        alert(data.msg);
        if (data.ok) { closeModal('teamQuotaModal'); loadLines(); loadUsers(); }
      } catch (e) { alert('æ“ä½œå¤±è´¥'); }
    }
    
    async function resetTeamUsage(name) {
      if (!confirm(`ç¡®å®šè¦é‡ç½®å›¢é˜Ÿ ${name} çš„ç”¨é‡å—ï¼Ÿ`)) return;
      const resetUsers = confirm('æ˜¯å¦åŒæ—¶é‡ç½®è¯¥å›¢é˜Ÿä¸‹æ‰€æœ‰æˆå‘˜çš„å¯¼å‡ºæ•°é‡ï¼Ÿ');
      try {
        const res = await fetch(`${API_BASE}/api/admin/resetLineUsage`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name, resetUsers }) });
        const data = await res.json();
        alert(data.msg);
        if (data.ok) { loadLines(); loadUsers(); loadStats(); }
      } catch (e) { alert('æ“ä½œå¤±è´¥'); }
    }
    
    async function removeLine(name) {
      if (!confirm(`ç¡®å®šè¦åˆ é™¤å›¢é˜Ÿ ${name} å—ï¼Ÿ`)) return;
      try {
        const res = await fetch(`${API_BASE}/api/admin/removeLine`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name }) });
        const data = await res.json();
        alert(data.msg);
        if (data.ok) loadLines();
      } catch (e) { alert('æ“ä½œå¤±è´¥'); }
    }
    
    // å¾…å®¡æ ¸
    async function loadPending() {
      try {
        const res = await fetch(`${API_BASE}/api/admin/pending`);
        const data = await res.json();
        if (data.ok) {
          if (data.users.length === 0) { document.getElementById('pendingList').innerHTML = '<div class="empty">æš‚æ— å¾…å®¡æ ¸ç”¨æˆ·</div>'; return; }
          let html = '<table><thead><tr><th>ç”¨æˆ·å</th><th>æ³¨å†Œæ—¶é—´</th><th>æ“ä½œ</th></tr></thead><tbody>';
          for (const user of data.users) {
            html += `<tr><td>${user.name}</td><td>${new Date(user.createdAt).toLocaleString()}</td><td><div class="action-btns"><button onclick="showApproveModal('${user.name}')">å®¡æ ¸</button><button class="danger" onclick="quickReject('${user.name}')">æ‹’ç»</button></div></td></tr>`;
          }
          html += '</tbody></table>';
          document.getElementById('pendingList').innerHTML = html;
        }
      } catch (e) { console.error('Load pending error:', e); }
    }
    
    function showApproveModal(username) {
      document.getElementById('approveUsername').textContent = username;
      document.getElementById('approveExpireDays').value = '';
      document.getElementById('approvePersonalQuota').value = '';
      document.getElementById('approveModal').classList.add('active');
    }
    
    async function approveUser() {
      const name = document.getElementById('approveUsername').textContent;
      const line = document.getElementById('approveLine').value;
      const expireDays = parseInt(document.getElementById('approveExpireDays').value) || 0;
      const personalQuota = parseInt(document.getElementById('approvePersonalQuota').value) || 0;
      try {
        const res = await fetch(`${API_BASE}/api/admin/approve`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name, line, expireDays, personalQuota }) });
        const data = await res.json();
        alert(data.msg);
        if (data.ok) { closeModal('approveModal'); loadPending(); loadUsers(); loadStats(); loadLines(); }
      } catch (e) { alert('æ“ä½œå¤±è´¥'); }
    }
    
    async function rejectUser() {
      const name = document.getElementById('approveUsername').textContent;
      if (!confirm(`ç¡®å®šè¦æ‹’ç»ç”¨æˆ· ${name} çš„æ³¨å†Œå—ï¼Ÿ`)) return;
      try {
        const res = await fetch(`${API_BASE}/api/admin/reject`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name }) });
        const data = await res.json();
        alert(data.msg);
        if (data.ok) { closeModal('approveModal'); loadPending(); }
      } catch (e) { alert('æ“ä½œå¤±è´¥'); }
    }
    
    async function quickReject(name) {
      if (!confirm(`ç¡®å®šè¦æ‹’ç»ç”¨æˆ· ${name} çš„æ³¨å†Œå—ï¼Ÿ`)) return;
      try {
        const res = await fetch(`${API_BASE}/api/admin/reject`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name }) });
        const data = await res.json();
        alert(data.msg);
        if (data.ok) loadPending();
      } catch (e) { alert('æ“ä½œå¤±è´¥'); }
    }
    
    // ç”¨æˆ·è¯¦æƒ…
    function showUserDetail(username) {
      const user = allUsers.find(u => u.name === username);
      if (!user) return;
      document.getElementById('modalUsername').textContent = username;
      const expireText = user.expireAt > 0 ? new Date(user.expireAt).toLocaleString() : 'æ°¸ä¹…';
      const pwd = user.password || '-';
      const quotaText = user.personalQuota > 0 ? user.personalQuota.toLocaleString() : 'è·Ÿéšå›¢é˜Ÿ';
      let html = `
        <div class="form-row"><strong>è´¦å·:</strong> ${user.name}</div>
        <div class="form-row"><strong>å¯†ç :</strong> <span class="password-cell">${pwd}</span> <button class="secondary" onclick="navigator.clipboard.writeText('${pwd}'); alert('å·²å¤åˆ¶');">å¤åˆ¶</button></div>
        <div class="form-row"><strong>çŠ¶æ€:</strong> ${user.status}</div>
        <div class="form-row"><strong>å›¢é˜Ÿ:</strong> ${user.line || 'æœªåˆ†é…'} <button class="secondary" onclick="changeUserLine('${username}')">ä¿®æ”¹</button></div>
        <div class="form-row"><strong>å¯¼å‡ºæ•°:</strong> ${user.exportCount.toLocaleString()} <button class="secondary" onclick="resetUserExport('${username}')">é‡ç½®</button></div>
        <div class="form-row"><strong>ä¸ªäººé…é¢:</strong> ${quotaText} <button class="secondary" onclick="changeUserQuota('${username}')">ä¿®æ”¹</button></div>
        <div class="form-row"><strong>æœ‰æ•ˆæœŸ:</strong> ${expireText} <button class="secondary" onclick="changeUserExpire('${username}')">ä¿®æ”¹</button></div>
        <div class="form-row"><strong>æ³¨å†Œæ—¶é—´:</strong> ${new Date(user.createdAt).toLocaleString()}</div>
      `;
      document.getElementById('userDetails').innerHTML = html;
      document.getElementById('userModal').classList.add('active');
    }
    
    async function changeUserLine(username) {
      const line = prompt('è¾“å…¥æ–°çš„å›¢é˜Ÿåç§°ï¼ˆç•™ç©ºå–æ¶ˆåˆ†é…ï¼‰:');
      if (line === null) return;
      try {
        const res = await fetch(`${API_BASE}/api/admin/setLine`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name: username, line }) });
        const data = await res.json();
        alert(data.msg);
        if (data.ok) { loadUsers(); loadLines(); closeModal('userModal'); }
      } catch (e) { alert('æ“ä½œå¤±è´¥'); }
    }
    
    async function changeUserExpire(username) {
      const days = prompt('è¾“å…¥æœ‰æ•ˆæœŸå¤©æ•°ï¼ˆ0=æ°¸ä¹…ï¼‰:');
      if (days === null) return;
      try {
        const res = await fetch(`${API_BASE}/api/admin/setExpire`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name: username, expireDays: parseInt(days) || 0 }) });
        const data = await res.json();
        alert(data.msg);
        if (data.ok) { loadUsers(); closeModal('userModal'); }
      } catch (e) { alert('æ“ä½œå¤±è´¥'); }
    }
    
    async function changeUserQuota(username) {
      const quota = prompt('è¾“å…¥ä¸ªäººé…é¢ï¼ˆ0=è·Ÿéšå›¢é˜Ÿï¼‰:');
      if (quota === null) return;
      try {
        const res = await fetch(`${API_BASE}/api/admin/batchSetQuota`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ usernames: [username], personalQuota: parseInt(quota) || 0 }) });
        const data = await res.json();
        alert(data.msg);
        if (data.ok) { loadUsers(); closeModal('userModal'); }
      } catch (e) { alert('æ“ä½œå¤±è´¥'); }
    }
    
    async function resetUserExport(username) {
      if (!confirm(`ç¡®å®šè¦é‡ç½® ${username} çš„å¯¼å‡ºæ•°é‡å—ï¼Ÿ`)) return;
      try {
        const res = await fetch(`${API_BASE}/api/admin/resetExport`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name: username }) });
        const data = await res.json();
        alert(data.msg);
        if (data.ok) { loadUsers(); closeModal('userModal'); }
      } catch (e) { alert('æ“ä½œå¤±è´¥'); }
    }
    
    async function showHistory(username) {
      document.getElementById('historyUsername').textContent = username;
      document.getElementById('historyContent').innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
      document.getElementById('historyModal').classList.add('active');
      try {
        const res = await fetch(`${API_BASE}/api/admin/exportHistory?name=${username}&limit=50`);
        const data = await res.json();
        if (data.ok) {
          if (data.history.length === 0) { document.getElementById('historyContent').innerHTML = '<div class="empty">æš‚æ— å¯¼å‡ºè®°å½•</div>'; return; }
          let html = `<div style="margin-bottom: 15px;"><strong>æ€»å¯¼å‡ºæ•°:</strong> ${data.totalExportCount.toLocaleString()}</div><table><thead><tr><th>æ—¶é—´</th><th>æ•°é‡</th></tr></thead><tbody>`;
          for (const record of data.history) html += `<tr><td>${new Date(record.timestamp).toLocaleString()}</td><td>${record.count.toLocaleString()}</td></tr>`;
          html += '</tbody></table>';
          document.getElementById('historyContent').innerHTML = html;
        }
      } catch (e) { document.getElementById('historyContent').innerHTML = '<div class="empty">åŠ è½½å¤±è´¥</div>'; }
    }
    
    async function toggleUser(username, enabled) {
      try {
        const res = await fetch(`${API_BASE}/api/admin/toggleUser`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name: username, enabled }) });
        const data = await res.json();
        alert(data.msg);
        if (data.ok) loadUsers();
      } catch (e) { alert('æ“ä½œå¤±è´¥'); }
    }
    
    async function kickUser(username) {
      if (!confirm(`ç¡®å®šè¦è¸¢å‡ºç”¨æˆ· ${username} å—ï¼Ÿ`)) return;
      try {
        const res = await fetch(`${API_BASE}/api/admin/kickUser`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name: username }) });
        const data = await res.json();
        alert(data.msg);
        if (data.ok) loadUsers();
      } catch (e) { alert('æ“ä½œå¤±è´¥'); }
    }
    
    async function removeUser(username) {
      if (!confirm(`ç¡®å®šè¦åˆ é™¤ç”¨æˆ· ${username} å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) return;
      try {
        const res = await fetch(`${API_BASE}/api/admin/removeUser`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name: username }) });
        const data = await res.json();
        alert(data.msg);
        if (data.ok) { loadUsers(); loadStats(); loadLines(); }
      } catch (e) { alert('æ“ä½œå¤±è´¥'); }
    }
    
    // ç³»ç»Ÿé…ç½®
    async function loadSystemConfig() {
      try {
        const res = await fetch(`${API_BASE}/api/system/config`);
        const data = await res.json();
        if (data.ok) {
          document.getElementById('maintenanceToggle').checked = data.config.maintenance;
          document.getElementById('maintenanceMsg').value = data.config.maintenanceMessage;
          document.getElementById('announcementToggle').checked = data.config.announcementEnabled;
          document.getElementById('announcementText').value = data.config.announcement;
        }
      } catch (e) { console.error('Load config error:', e); }
    }
    
    async function toggleMaintenance() {
      const maintenance = document.getElementById('maintenanceToggle').checked;
      try { await fetch(`${API_BASE}/api/system/config`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ maintenance }) }); }
      catch (e) { alert('æ“ä½œå¤±è´¥'); }
    }
    
    async function saveMaintenanceMsg() {
      const maintenanceMessage = document.getElementById('maintenanceMsg').value;
      try {
        const res = await fetch(`${API_BASE}/api/system/config`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ maintenanceMessage }) });
        const data = await res.json();
        alert(data.msg);
      } catch (e) { alert('æ“ä½œå¤±è´¥'); }
    }
    
    async function toggleAnnouncement() {
      const announcementEnabled = document.getElementById('announcementToggle').checked;
      try { await fetch(`${API_BASE}/api/system/config`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ announcementEnabled }) }); }
      catch (e) { alert('æ“ä½œå¤±è´¥'); }
    }
    
    async function saveAnnouncement() {
      const announcement = document.getElementById('announcementText').value;
      try {
        const res = await fetch(`${API_BASE}/api/system/config`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ announcement }) });
        const data = await res.json();
        alert(data.msg);
      } catch (e) { alert('æ“ä½œå¤±è´¥'); }
    }
    
    async function kickAllUsers() {
      if (!confirm('ç¡®å®šè¦è¸¢å‡ºæ‰€æœ‰ç”¨æˆ·å—ï¼Ÿæ‰€æœ‰ç”¨æˆ·éœ€è¦é‡æ–°ç™»å½•ï¼')) return;
      try {
        const res = await fetch(`${API_BASE}/api/system/kickAll`, { method: 'POST', headers: { 'Content-Type': 'application/json' } });
        const data = await res.json();
        alert(data.msg);
        if (data.ok) { loadUsers(); loadStats(); }
      } catch (e) { alert('æ“ä½œå¤±è´¥'); }
    }
    
    function closeModal(id) { document.getElementById(id).classList.remove('active'); }
    document.querySelectorAll('.modal').forEach(modal => {
      modal.addEventListener('click', (e) => { if (e.target === modal) modal.classList.remove('active'); });
    });
  </script>
</body>
</html>
