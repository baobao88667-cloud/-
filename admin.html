<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TPS Helper ç®¡ç†åå°</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; min-height: 100vh; }
    .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; }
    .header h1 { font-size: 24px; }
    .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
    .tabs { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
    .tab { padding: 10px 20px; background: white; border: none; border-radius: 8px; cursor: pointer; }
    .tab:hover, .tab.active { background: #667eea; color: white; }
    .panel { display: none; background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
    .panel.active { display: block; }
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 20px; }
    .stat-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 10px; }
    .stat-card h3 { font-size: 28px; }
    .toolbar { display: flex; gap: 10px; margin-bottom: 15px; flex-wrap: wrap; align-items: center; }
    .toolbar input, .toolbar select { padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; }
    .btn { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; }
    .btn-primary { background: #667eea; color: white; }
    .btn-success { background: #10b981; color: white; }
    .btn-danger { background: #ef4444; color: white; }
    .btn-warning { background: #f59e0b; color: white; }
    .btn-info { background: #3b82f6; color: white; }
    .btn-secondary { background: #6b7280; color: white; }
    .btn-sm { padding: 4px 8px; font-size: 12px; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
    th { background: #f8f9fa; }
    .status { padding: 4px 8px; border-radius: 4px; font-size: 12px; }
    .status-approved { background: #d1fae5; color: #065f46; }
    .status-disabled { background: #fee2e2; color: #991b1b; }
    .status-locked { background: #fecaca; color: #7f1d1d; }
    .mode-tag { padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; }
    .mode-normal { background: linear-gradient(135deg, #10b981, #3b82f6); color: white; }
    .mode-guest { background: linear-gradient(135deg, #f59e0b, #ef4444); color: white; }
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
    .modal.show { display: flex; }
    .modal-content { background: white; padding: 25px; border-radius: 12px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto; }
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; margin-bottom: 5px; font-weight: 500; }
    .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; }
    .batch-bar { background: #eef2ff; padding: 15px; border-radius: 8px; margin-bottom: 15px; display: none; align-items: center; gap: 15px; flex-wrap: wrap; }
    .batch-bar.show { display: flex; }
    .line-card { background: #f8f9fa; border-radius: 8px; padding: 15px; margin-bottom: 10px; }
    .line-card h4 { margin-bottom: 10px; }
    .line-card .line-info { color: #666; margin-bottom: 10px; }
    .line-card .line-actions { display: flex; gap: 8px; flex-wrap: wrap; }
    .progress-bar { height: 8px; background: #e5e7eb; border-radius: 4px; overflow: hidden; margin: 10px 0; }
    .progress-fill { height: 100%; background: linear-gradient(90deg, #667eea, #764ba2); }
    .switch { position: relative; display: inline-block; width: 50px; height: 26px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; border-radius: 26px; }
    .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 3px; bottom: 3px; background-color: white; border-radius: 50%; transition: .3s; }
    input:checked + .slider { background-color: #667eea; }
    input:checked + .slider:before { transform: translateX(24px); }
    .action-group { display: flex; gap: 4px; flex-wrap: wrap; }
    .toast { position: fixed; top: 20px; right: 20px; padding: 12px 20px; border-radius: 8px; color: white; z-index: 9999; animation: slideIn 0.3s ease; }
    .toast.success { background: #10b981; }
    .toast.error { background: #ef4444; }
    .toast.info { background: #3b82f6; }
    @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
  </style>
</head>
<body>
  <div class="header"><h1>ğŸ” TPS Helper ç®¡ç†åå°</h1></div>
  <div class="container">
    <div class="tabs">
      <button class="tab active" data-panel="dashboard">ğŸ“Š ä»ªè¡¨ç›˜</button>
      <button class="tab" data-panel="users">ğŸ‘¥ ç”¨æˆ·ç®¡ç†</button>
      <button class="tab" data-panel="pending">â³ å¾…å®¡æ ¸</button>
      <button class="tab" data-panel="lines">ğŸ“¦ å›¢é˜Ÿ/çº¿è·¯</button>
      <button class="tab" data-panel="system">âš™ï¸ ç³»ç»Ÿæ§åˆ¶</button>
    </div>

    <div class="panel active" id="dashboard">
      <div class="stats-grid" id="statsGrid"></div>
    </div>

    <div class="panel" id="users">
      <div class="toolbar">
        <input type="text" id="userSearch" placeholder="æœç´¢ç”¨æˆ·å...">
        <select id="userStatusFilter"><option value="">å…¨éƒ¨çŠ¶æ€</option><option value="approved">æ­£å¸¸</option><option value="disabled">å·²ç¦ç”¨</option><option value="locked">å·²é”å®š</option></select>
        <select id="userLineFilter"><option value="">å…¨éƒ¨çº¿è·¯</option></select>
        <select id="userModeFilter"><option value="">å…¨éƒ¨æ¨¡å¼</option><option value="normal">æ­£å¸¸ç”¨æˆ·</option><option value="guest">è®¿å®¢</option></select>
        <label><input type="checkbox" id="showPasswords"> æ˜¾ç¤ºå¯†ç </label>
        <button class="btn btn-primary btn-sm" onclick="loadUsers()">ğŸ”„ åˆ·æ–°</button>
      </div>
      <div class="batch-bar" id="batchBar">
        <span id="selectedCount">å·²é€‰æ‹© 0 ä¸ªç”¨æˆ·</span>
        <select id="batchLine"><option value="">é€‰æ‹©çº¿è·¯</option></select>
        <button class="btn btn-primary btn-sm" onclick="batchSetLine()">æ‰¹é‡è®¾ç½®çº¿è·¯</button>
        <input type="number" id="batchExpireDays" placeholder="å¤©æ•°" style="width:80px">
        <button class="btn btn-warning btn-sm" onclick="batchSetExpire()">æ‰¹é‡è®¾ç½®æœ‰æ•ˆæœŸ</button>
        <input type="number" id="batchQuota" placeholder="ç§¯åˆ†" style="width:80px">
        <button class="btn btn-success btn-sm" onclick="batchSetQuota()">æ‰¹é‡è®¾ç½®ç§¯åˆ†</button>
        <button class="btn btn-danger btn-sm" onclick="batchResetExport()">æ‰¹é‡é‡ç½®å¯¼å‡ºæ•°</button>
        <button class="btn btn-secondary btn-sm" onclick="batchRemoveFromLine()">æ‹‰å‡ºå›¢é˜Ÿ</button>
        <button class="btn btn-info btn-sm" onclick="showBatchModeModal()">æ‰¹é‡æ¨¡å¼åˆ‡æ¢</button>
      </div>
      <table>
        <thead><tr><th><input type="checkbox" id="selectAll" onchange="toggleSelectAll()"></th><th>ç”¨æˆ·å</th><th>å¯†ç </th><th>çŠ¶æ€</th><th>æ¨¡å¼</th><th>çº¿è·¯</th><th>æœ‰æ•ˆæœŸ</th><th>å·²ç”¨/ç§¯åˆ†</th><th>æ“ä½œ</th></tr></thead>
        <tbody id="usersTable"></tbody>
      </table>
    </div>

    <div class="panel" id="pending">
      <table>
        <thead><tr><th>ç”¨æˆ·å</th><th>å¯†ç </th><th>æ³¨å†Œæ—¶é—´</th><th>æ“ä½œ</th></tr></thead>
        <tbody id="pendingTable"></tbody>
      </table>
    </div>

    <div class="panel" id="lines">
      <div class="toolbar">
        <button class="btn btn-primary" onclick="showAddLineModal()">â• æ·»åŠ å›¢é˜Ÿ/çº¿è·¯</button>
      </div>
      <div id="linesContainer"></div>
    </div>

    <div class="panel" id="system">
      <h3 style="margin-bottom:20px">ğŸ”§ ç³»ç»Ÿè®¾ç½®</h3>
      <div class="form-group"><label>ç»´æŠ¤æ¨¡å¼</label><label class="switch"><input type="checkbox" id="maintenanceMode" onchange="saveConfig()"><span class="slider"></span></label></div>
      <div class="form-group"><label>ç»´æŠ¤æç¤ºè¯­</label><input type="text" id="maintenanceMessage" onchange="saveConfig()"></div>
      <div class="form-group"><label>å…¬å‘Šå¼€å…³</label><label class="switch"><input type="checkbox" id="announcementEnabled" onchange="saveConfig()"><span class="slider"></span></label></div>
      <div class="form-group"><label>å…¬å‘Šå†…å®¹</label><textarea id="announcement" rows="4" onchange="saveConfig()"></textarea></div>
      <hr style="margin:20px 0">
      <button class="btn btn-danger" onclick="kickAllUsers()">ğŸš¨ ä¸€é”®è¸¢å‡ºæ‰€æœ‰ç”¨æˆ·</button>
    </div>
  </div>

  <!-- å®¡æ ¸ç”¨æˆ·å¼¹çª— -->
  <div class="modal" id="approveModal">
    <div class="modal-content">
      <h3 style="margin-bottom:20px">âœ… å®¡æ ¸ç”¨æˆ·</h3>
      <input type="hidden" id="approveUsername">
      <div class="form-group"><label>åˆ†é…çº¿è·¯ï¼ˆå¯é€‰ï¼‰</label><select id="approveLine"><option value="">ä¸åˆ†é…</option></select></div>
      <p style="color:#f59e0b;margin-bottom:15px">âš ï¸ å®¡æ ¸é€šè¿‡åï¼Œç”¨æˆ·å°†é»˜è®¤ä¸º<strong>è®¿å®¢æ¨¡å¼</strong>ï¼Œéœ€è¦æ‰‹åŠ¨è®¾ç½®æœ‰æ•ˆæœŸæˆ–ç§¯åˆ†ååˆ‡æ¢ä¸ºæ­£å¸¸ç”¨æˆ·ã€‚</p>
      <button class="btn btn-success" onclick="approveUser()" style="width:100%">âœ“ å®¡æ ¸é€šè¿‡ï¼ˆè®¾ä¸ºè®¿å®¢ï¼‰</button>
    </div>
  </div>

  <!-- æ·»åŠ çº¿è·¯å¼¹çª— -->
  <div class="modal" id="addLineModal">
    <div class="modal-content">
      <h3 style="margin-bottom:20px">â• æ·»åŠ å›¢é˜Ÿ/çº¿è·¯</h3>
      <div class="form-group"><label>åç§°</label><input type="text" id="newLineName"></div>
      <div class="form-group"><label>æ€»ç§¯åˆ†</label><input type="number" id="newLineQuota" placeholder="0 = æ— é™åˆ¶"></div>
      <div class="form-group"><label>ç§¯åˆ†æ¨¡å¼</label><select id="newLineQuotaMode"><option value="shared">å…±äº«æ¨¡å¼ï¼ˆå›¢é˜Ÿå…±ç”¨ï¼‰</option><option value="split">å¹³æ‘Šæ¨¡å¼ï¼ˆäººå‡åˆ†é…ï¼‰</option></select></div>
      <button class="btn btn-primary" onclick="addLine()" style="width:100%">æ·»åŠ </button>
    </div>
  </div>

  <!-- è®¾ç½®å•ä¸ªç”¨æˆ·æœ‰æ•ˆæœŸå¼¹çª— -->
  <div class="modal" id="setExpireModal">
    <div class="modal-content">
      <h3 style="margin-bottom:20px">â° è®¾ç½®æœ‰æ•ˆæœŸ</h3>
      <input type="hidden" id="setExpireUsername">
      <p style="margin-bottom:15px">ç”¨æˆ·ï¼š<strong id="setExpireUserDisplay"></strong></p>
      <div class="form-group"><label>æœ‰æ•ˆæœŸï¼ˆå¤©ï¼‰</label><input type="number" id="setExpireDays" placeholder="è¾“å…¥å¤©æ•°ï¼Œ0 = æ¸…é™¤æœ‰æ•ˆæœŸ"></div>
      <button class="btn btn-warning" onclick="setUserExpire()" style="width:100%">ç¡®è®¤è®¾ç½®</button>
    </div>
  </div>

  <!-- è®¾ç½®å•ä¸ªç”¨æˆ·ç§¯åˆ†å¼¹çª— -->
  <div class="modal" id="setQuotaModal">
    <div class="modal-content">
      <h3 style="margin-bottom:20px">ğŸ“Š è®¾ç½®ä¸ªäººç§¯åˆ†</h3>
      <input type="hidden" id="setQuotaUsername">
      <p style="margin-bottom:15px">ç”¨æˆ·ï¼š<strong id="setQuotaUserDisplay"></strong></p>
      <div class="form-group"><label>ä¸ªäººç§¯åˆ†</label><input type="number" id="setQuotaValue" placeholder="0 = è·Ÿéšå›¢é˜Ÿç§¯åˆ†"></div>
      <button class="btn btn-success" onclick="setUserQuota()" style="width:100%">ç¡®è®¤è®¾ç½®</button>
    </div>
  </div>

  <!-- å•ä¸ªç”¨æˆ·æ¨¡å¼åˆ‡æ¢å¼¹çª— -->
  <div class="modal" id="setUserModeModal">
    <div class="modal-content">
      <h3 style="margin-bottom:20px">ğŸ”„ åˆ‡æ¢ç”¨æˆ·æ¨¡å¼</h3>
      <input type="hidden" id="setModeUsername">
      <p style="margin-bottom:15px">ç”¨æˆ·ï¼š<strong id="setModeUserDisplay"></strong></p>
      <p id="setModeCurrentStatus" style="margin-bottom:15px;color:#666"></p>
      <div class="form-group">
        <label>é€‰æ‹©æ¨¡å¼</label>
        <select id="setModeValue">
          <option value="guest">è®¿å®¢ï¼ˆä¸èƒ½ä½¿ç”¨åŠŸèƒ½ï¼‰</option>
          <option value="normal">æ­£å¸¸ç”¨æˆ·ï¼ˆéœ€è¦æœ‰æ•ˆæœŸæˆ–ç§¯åˆ†ï¼‰</option>
        </select>
      </div>
      <p id="setModeWarning" style="color:#ef4444;margin-bottom:15px;display:none"></p>
      <button class="btn btn-primary" onclick="setUserMode()" style="width:100%">ç¡®è®¤åˆ‡æ¢</button>
    </div>
  </div>

  <!-- æ‰¹é‡ç”¨æˆ·æ¨¡å¼åˆ‡æ¢å¼¹çª— -->
  <div class="modal" id="batchModeModal">
    <div class="modal-content">
      <h3 style="margin-bottom:20px">ğŸ”„ æ‰¹é‡åˆ‡æ¢ç”¨æˆ·æ¨¡å¼</h3>
      <p style="margin-bottom:15px">å·²é€‰æ‹© <strong id="batchModeCount">0</strong> ä¸ªç”¨æˆ·</p>
      <div class="form-group">
        <label>é€‰æ‹©æ¨¡å¼</label>
        <select id="batchModeValue">
          <option value="guest">è®¿å®¢ï¼ˆä¸èƒ½ä½¿ç”¨åŠŸèƒ½ï¼‰</option>
          <option value="normal">æ­£å¸¸ç”¨æˆ·ï¼ˆéœ€è¦æœ‰æ•ˆæœŸæˆ–ç§¯åˆ†ï¼‰</option>
        </select>
      </div>
      <p style="color:#f59e0b;margin-bottom:15px">âš ï¸ åˆ‡æ¢ä¸ºæ­£å¸¸ç”¨æˆ·æ—¶ï¼Œæ²¡æœ‰æœ‰æ•ˆæœŸæˆ–ç§¯åˆ†çš„ç”¨æˆ·å°†ä¿æŒè®¿å®¢çŠ¶æ€ã€‚</p>
      <button class="btn btn-primary" onclick="batchSetMode()" style="width:100%">ç¡®è®¤æ‰¹é‡åˆ‡æ¢</button>
    </div>
  </div>

  <!-- ä¿®æ”¹çº¿è·¯ç§¯åˆ†å¼¹çª— -->
  <div class="modal" id="editLineQuotaModal">
    <div class="modal-content">
      <h3 style="margin-bottom:20px">ğŸ“ ä¿®æ”¹å›¢é˜Ÿç§¯åˆ†</h3>
      <input type="hidden" id="editLineName">
      <p style="margin-bottom:15px">å›¢é˜Ÿï¼š<strong id="editLineDisplay"></strong></p>
      <div class="form-group"><label>æ€»ç§¯åˆ†</label><input type="number" id="editLineQuotaValue" placeholder="0 = æ— é™åˆ¶"></div>
      <button class="btn btn-primary" onclick="updateLineQuota()" style="width:100%">ç¡®è®¤ä¿®æ”¹</button>
    </div>
  </div>

  <!-- è®¾ç½®çº¿è·¯ç”¨æˆ·æœ‰æ•ˆæœŸå¼¹çª— -->
  <div class="modal" id="lineExpireModal">
    <div class="modal-content">
      <h3 style="margin-bottom:20px">â° æ‰¹é‡è®¾ç½®æœ‰æ•ˆæœŸ</h3>
      <input type="hidden" id="lineExpireName">
      <p style="margin-bottom:15px">å›¢é˜Ÿï¼š<strong id="lineExpireDisplay"></strong></p>
      <p style="margin-bottom:15px;color:#666">å°†ä¸ºè¯¥å›¢é˜Ÿæ‰€æœ‰ç”¨æˆ·è®¾ç½®ç›¸åŒçš„æœ‰æ•ˆæœŸ</p>
      <div class="form-group"><label>æœ‰æ•ˆæœŸï¼ˆå¤©ï¼‰</label><input type="number" id="lineExpireDays" placeholder="è¾“å…¥å¤©æ•°"></div>
      <button class="btn btn-warning" onclick="setLineUsersExpire()" style="width:100%">ç¡®è®¤è®¾ç½®</button>
    </div>
  </div>

  <script>
    let allUsers = [], allLines = [], selectedUsers = new Set(), showPasswords = false;

    document.addEventListener('DOMContentLoaded', () => {
      loadStats(); loadUsers(); loadPending(); loadLines(); loadConfig();
      document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', () => {
          document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
          document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
          tab.classList.add('active');
          document.getElementById(tab.dataset.panel).classList.add('active');
        });
      });
      document.getElementById('userSearch').addEventListener('input', renderUsers);
      document.getElementById('userStatusFilter').addEventListener('change', renderUsers);
      document.getElementById('userLineFilter').addEventListener('change', renderUsers);
      document.getElementById('userModeFilter').addEventListener('change', renderUsers);
      document.getElementById('showPasswords').addEventListener('change', e => { showPasswords = e.target.checked; renderUsers(); });
    });

    function showToast(message, type = 'info') {
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }

    async function api(endpoint, method = 'GET', data = null) {
      const options = { method, headers: { 'Content-Type': 'application/json' } };
      if (data) options.body = JSON.stringify(data);
      try {
        const res = await fetch(endpoint, options);
        const json = await res.json();
        console.log(`[API] ${method} ${endpoint}`, { request: data, response: json });
        return json;
      } catch (error) {
        console.error(`[API] Error:`, error);
        return { ok: false, msg: 'ç½‘ç»œè¯·æ±‚å¤±è´¥: ' + error.message };
      }
    }

    function calculateUserMode(user) {
      if (user.userMode) return user.userMode;
      const now = Date.now();
      const hasValidExpire = user.expireAt && parseInt(user.expireAt) > now;
      const hasCredits = (user.personalQuota > 0 && user.personalQuota > user.exportCount) || 
                        (user.line && allLines.find(l => l.name === user.line && l.quota > l.used));
      if (hasValidExpire && hasCredits) return 'normal';
      return 'guest';
    }

    async function loadStats() {
      const res = await api('/api/admin?action=stats');
      if (res.ok) {
        const s = res.stats;
        document.getElementById('statsGrid').innerHTML = `
          <div class="stat-card"><h3>${s.totalUsers}</h3><p>æ€»ç”¨æˆ·æ•°</p></div>
          <div class="stat-card"><h3>${s.pendingUsers}</h3><p>å¾…å®¡æ ¸</p></div>
          <div class="stat-card"><h3>${s.activeUsers}</h3><p>æ´»è·ƒç”¨æˆ·</p></div>
          <div class="stat-card"><h3>${s.totalLines}</h3><p>å›¢é˜Ÿ/çº¿è·¯</p></div>
          <div class="stat-card"><h3>${s.totalExports.toLocaleString()}</h3><p>æ€»å¯¼å‡ºæ•°</p></div>`;
      }
    }

    async function loadUsers() {
      const res = await api('/api/admin?action=users');
      if (res.ok) { 
        allUsers = res.users; 
        console.log('[loadUsers] Loaded users:', allUsers);
        updateLineFilter(); 
        renderUsers(); 
      }
    }

    function updateLineFilter() {
      const userLines = [...new Set(allUsers.map(u => u.line).filter(l => l))];
      const userLineOptions = userLines.map(l => `<option value="${l}">${l}</option>`).join('');
      document.getElementById('userLineFilter').innerHTML = '<option value="">å…¨éƒ¨çº¿è·¯</option>' + userLineOptions;
      const allLineOptions = allLines.map(l => `<option value="${l.name}">${l.name}</option>`).join('');
      document.getElementById('batchLine').innerHTML = '<option value="">é€‰æ‹©çº¿è·¯</option>' + allLineOptions;
      document.getElementById('approveLine').innerHTML = '<option value="">ä¸åˆ†é…</option>' + allLineOptions;
    }

    function renderUsers() {
      const search = document.getElementById('userSearch').value.toLowerCase();
      const status = document.getElementById('userStatusFilter').value;
      const line = document.getElementById('userLineFilter').value;
      const modeFilter = document.getElementById('userModeFilter').value;
      
      let filtered = allUsers.filter(u => {
        if (search && !u.username.toLowerCase().includes(search)) return false;
        if (status === 'disabled' && u.enabled) return false;
        if (status === 'approved' && (!u.enabled || u.status !== 'approved')) return false;
        if (status === 'locked' && u.status !== 'locked') return false;
        if (line && u.line !== line) return false;
        if (modeFilter) {
          const userMode = calculateUserMode(u);
          if (userMode !== modeFilter) return false;
        }
        return true;
      });
      
      const tbody = document.getElementById('usersTable');
      if (filtered.length === 0) { tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;padding:40px">æš‚æ— æ•°æ®</td></tr>'; return; }
      
      tbody.innerHTML = filtered.map(u => {
        const statusClass = u.enabled ? `status-${u.status}` : 'status-disabled';
        const statusText = !u.enabled ? 'å·²ç¦ç”¨' : (u.status === 'approved' ? 'æ­£å¸¸' : u.status === 'locked' ? 'å·²é”å®š' : u.status);
        
        let expireText = 'æœªè®¾ç½®';
        if (u.expireAt) {
          const expireDate = new Date(parseInt(u.expireAt));
          const now = new Date();
          if (expireDate > now) {
            expireText = expireDate.toLocaleDateString();
          } else {
            expireText = `<span style="color:#ef4444">å·²è¿‡æœŸ</span>`;
          }
        }
        
        const quotaText = u.personalQuota > 0 ? `${u.exportCount.toLocaleString()}/${u.personalQuota.toLocaleString()}` : u.exportCount.toLocaleString();
        const pwdDisplay = showPasswords ? u.password : 'â€¢â€¢â€¢â€¢â€¢â€¢';
        
        const userMode = calculateUserMode(u);
        const modeClass = userMode === 'normal' ? 'mode-normal' : 'mode-guest';
        const modeText = userMode === 'normal' ? 'æ­£å¸¸ç”¨æˆ·' : 'è®¿å®¢';
        
        const toggleEnabled = !u.enabled;
        return `<tr>
          <td><input type="checkbox" class="user-checkbox" data-username="${u.username}" onchange="updateSelection()" ${selectedUsers.has(u.username) ? 'checked' : ''}></td>
          <td><strong>${u.username}</strong></td>
          <td style="font-family:monospace;cursor:pointer" onclick="navigator.clipboard.writeText('${u.password}');showToast('å·²å¤åˆ¶å¯†ç ', 'success')">${pwdDisplay}</td>
          <td><span class="status ${statusClass}">${statusText}</span></td>
          <td><span class="mode-tag ${modeClass}">${modeText}</span></td>
          <td>${u.line || '-'}</td>
          <td>${expireText}</td>
          <td>${quotaText}</td>
          <td class="action-group">
            <button class="btn btn-sm btn-info" onclick="showSetExpireModal('${u.username}')">æœ‰æ•ˆæœŸ</button>
            <button class="btn btn-sm btn-success" onclick="showSetQuotaModal('${u.username}')">ç§¯åˆ†</button>
            <button class="btn btn-sm ${u.enabled ? 'btn-warning' : 'btn-success'}" onclick="toggleUser('${u.username}', ${toggleEnabled})" id="toggle-${u.username}">${u.enabled ? 'ç¦ç”¨' : 'å¯ç”¨'}</button>
            <button class="btn btn-sm btn-danger" onclick="kickUser('${u.username}')">è¸¢å‡º</button>
            <button class="btn btn-sm btn-danger" onclick="removeUser('${u.username}')">åˆ é™¤</button>
            <button class="btn btn-sm btn-primary" onclick="resetExport('${u.username}')">æ¸…é›¶</button>
            <button class="btn btn-sm btn-secondary" onclick="showSetUserModeModal('${u.username}', '${userMode}')">æ¨¡å¼</button>
          </td>
        </tr>`;
      }).join('');
    }

    function updateSelection() {
      selectedUsers.clear();
      document.querySelectorAll('.user-checkbox:checked').forEach(cb => selectedUsers.add(cb.dataset.username));
      document.getElementById('selectedCount').textContent = `å·²é€‰æ‹© ${selectedUsers.size} ä¸ªç”¨æˆ·`;
      document.getElementById('batchBar').classList.toggle('show', selectedUsers.size > 0);
    }

    function toggleSelectAll() {
      const checked = document.getElementById('selectAll').checked;
      document.querySelectorAll('.user-checkbox').forEach(cb => cb.checked = checked);
      updateSelection();
    }

    function showSetExpireModal(username) {
      document.getElementById('setExpireUsername').value = username;
      document.getElementById('setExpireUserDisplay').textContent = username;
      document.getElementById('setExpireDays').value = '';
      document.getElementById('setExpireModal').classList.add('show');
    }

    async function setUserExpire() {
      const username = document.getElementById('setExpireUsername').value;
      const expireDays = parseInt(document.getElementById('setExpireDays').value) || 0;
      const res = await api('/api/admin?action=setExpire', 'POST', { username, expireDays });
      if (res.ok) {
        showToast(res.msg, 'success');
        document.getElementById('setExpireModal').classList.remove('show');
        loadUsers();
      } else {
        showToast(res.msg || 'æ“ä½œå¤±è´¥', 'error');
      }
    }

    function showSetQuotaModal(username) {
      document.getElementById('setQuotaUsername').value = username;
      document.getElementById('setQuotaUserDisplay').textContent = username;
      document.getElementById('setQuotaValue').value = '';
      document.getElementById('setQuotaModal').classList.add('show');
    }

    async function setUserQuota() {
      const username = document.getElementById('setQuotaUsername').value;
      const personalQuota = parseInt(document.getElementById('setQuotaValue').value) || 0;
      const res = await api('/api/admin?action=setQuota', 'POST', { username, personalQuota });
      if (res.ok) {
        showToast(res.msg, 'success');
        document.getElementById('setQuotaModal').classList.remove('show');
        loadUsers();
      } else {
        showToast(res.msg || 'æ“ä½œå¤±è´¥', 'error');
      }
    }

    function showSetUserModeModal(username, currentMode) {
      document.getElementById('setModeUsername').value = username;
      document.getElementById('setModeUserDisplay').textContent = username;
      document.getElementById('setModeValue').value = currentMode;
      
      const user = allUsers.find(u => u.username === username);
      if (user) {
        const now = Date.now();
        const hasValidExpire = user.expireAt && parseInt(user.expireAt) > now;
        const hasCredits = user.personalQuota > 0 && user.personalQuota > user.exportCount;
        
        let statusText = `å½“å‰çŠ¶æ€: `;
        statusText += hasValidExpire ? `æœ‰æ•ˆæœŸè‡³ ${new Date(parseInt(user.expireAt)).toLocaleDateString()}` : 'æ— æœ‰æ•ˆæœŸ';
        statusText += `, `;
        statusText += hasCredits ? `å‰©ä½™ç§¯åˆ† ${(user.personalQuota - user.exportCount).toLocaleString()}` : 'æ— ç§¯åˆ†';
        document.getElementById('setModeCurrentStatus').textContent = statusText;
        
        // OR é€»è¾‘ï¼šæœ‰æ•ˆæœŸ OR ç§¯åˆ†ï¼Œä»»ä¸€æ»¡è¶³å³å¯
        if (!hasValidExpire && !hasCredits) {
          document.getElementById('setModeWarning').textContent = 'âš ï¸ è¯¥ç”¨æˆ·æ²¡æœ‰æœ‰æ•ˆæœŸä¸”æ²¡æœ‰ç§¯åˆ†ï¼Œæ— æ³•åˆ‡æ¢ä¸ºæ­£å¸¸ç”¨æˆ·';
          document.getElementById('setModeWarning').style.display = 'block';
        } else {
          document.getElementById('setModeWarning').style.display = 'none';
        }
      }
      
      document.getElementById('setUserModeModal').classList.add('show');
    }

    async function setUserMode() {
      const username = document.getElementById('setModeUsername').value;
      const userMode = document.getElementById('setModeValue').value;
      
      const res = await api('/api/admin?action=setUserMode', 'POST', { username, userMode });
      if (res.ok) {
        showToast(res.msg, 'success');
        document.getElementById('setUserModeModal').classList.remove('show');
        loadUsers();
      } else {
        showToast(res.msg || 'æ“ä½œå¤±è´¥', 'error');
      }
    }

    function showBatchModeModal() {
      if (selectedUsers.size === 0) {
        return showToast('è¯·å…ˆé€‰æ‹©ç”¨æˆ·', 'error');
      }
      document.getElementById('batchModeCount').textContent = selectedUsers.size;
      document.getElementById('batchModeModal').classList.add('show');
    }

    async function batchSetMode() {
      const userMode = document.getElementById('batchModeValue').value;
      const res = await api('/api/admin?action=batchSetUserMode', 'POST', { usernames: [...selectedUsers], userMode });
      if (res.ok) {
        showToast(res.msg, 'success');
        document.getElementById('batchModeModal').classList.remove('show');
        loadUsers();
      } else {
        showToast(res.msg || 'æ“ä½œå¤±è´¥', 'error');
      }
    }

    async function batchSetLine() {
      const line = document.getElementById('batchLine').value;
      const res = await api('/api/admin?action=batchSetLine', 'POST', { usernames: [...selectedUsers], line });
      if (res.ok) {
        showToast(res.msg, 'success');
        loadUsers();
      } else {
        showToast(res.msg || 'æ“ä½œå¤±è´¥', 'error');
      }
    }

    async function batchSetExpire() {
      const expireDays = parseInt(document.getElementById('batchExpireDays').value) || 0;
      const res = await api('/api/admin?action=batchSetExpire', 'POST', { usernames: [...selectedUsers], expireDays });
      if (res.ok) {
        showToast(res.msg, 'success');
        loadUsers();
      } else {
        showToast(res.msg || 'æ“ä½œå¤±è´¥', 'error');
      }
    }

    async function batchSetQuota() {
      const personalQuota = parseInt(document.getElementById('batchQuota').value) || 0;
      const res = await api('/api/admin?action=batchSetQuota', 'POST', { usernames: [...selectedUsers], personalQuota });
      if (res.ok) {
        showToast(res.msg, 'success');
        loadUsers();
      } else {
        showToast(res.msg || 'æ“ä½œå¤±è´¥', 'error');
      }
    }

    async function batchResetExport() {
      if (!confirm('ç¡®å®šè¦é‡ç½®é€‰ä¸­ç”¨æˆ·çš„å¯¼å‡ºæ•°å—ï¼Ÿ')) return;
      const res = await api('/api/admin?action=batchResetExport', 'POST', { usernames: [...selectedUsers] });
      if (res.ok) {
        showToast(res.msg, 'success');
        loadUsers();
      } else {
        showToast(res.msg || 'æ“ä½œå¤±è´¥', 'error');
      }
    }

    async function batchRemoveFromLine() {
      if (selectedUsers.size === 0) {
        return showToast('è¯·å…ˆé€‰æ‹©ç”¨æˆ·', 'error');
      }
      if (!confirm(`ç¡®å®šè¦å°†é€‰ä¸­çš„ ${selectedUsers.size} ä¸ªç”¨æˆ·æ‹‰å‡ºå›¢é˜Ÿå—ï¼Ÿ`)) return;
      const res = await api('/api/admin?action=batchSetLine', 'POST', { usernames: [...selectedUsers], line: '' });
      if (res.ok) {
        showToast(`å·²å°† ${selectedUsers.size} ä¸ªç”¨æˆ·æ‹‰å‡ºå›¢é˜Ÿ`, 'success');
        loadUsers();
      } else {
        showToast(res.msg || 'æ“ä½œå¤±è´¥', 'error');
      }
    }

    async function toggleUser(username, enabled) {
      console.log(`[toggleUser] Called with username: ${username}, enabled: ${enabled}, type: ${typeof enabled}`);
      const btn = document.getElementById(`toggle-${username}`);
      if (btn) {
        btn.disabled = true;
        btn.textContent = 'å¤„ç†ä¸­...';
      }
      try {
        const res = await api('/api/admin?action=toggleUser', 'POST', { username, enabled: enabled });
        console.log(`[toggleUser] Response:`, res);
        if (res.ok) {
          showToast(res.msg || (enabled ? 'å·²å¯ç”¨' : 'å·²ç¦ç”¨'), 'success');
          await loadUsers();
        } else {
          showToast(res.msg || 'æ“ä½œå¤±è´¥', 'error');
          if (btn) {
            btn.disabled = false;
            btn.textContent = enabled ? 'å¯ç”¨' : 'ç¦ç”¨';
          }
        }
      } catch (error) {
        console.error(`[toggleUser] Error:`, error);
        showToast('ç½‘ç»œè¯·æ±‚å¤±è´¥: ' + error.message, 'error');
        if (btn) {
          btn.disabled = false;
          btn.textContent = enabled ? 'å¯ç”¨' : 'ç¦ç”¨';
        }
      }
    }

    async function kickUser(username) {
      if (!confirm(`ç¡®å®šè¦è¸¢å‡º ${username} å—ï¼Ÿ`)) return;
      const res = await api('/api/admin?action=kickUser', 'POST', { username });
      showToast(res.msg, res.ok ? 'success' : 'error');
    }

    async function removeUser(username) {
      if (!confirm(`ç¡®å®šè¦åˆ é™¤ ${username} å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) return;
      const res = await api('/api/admin?action=removeUser', 'POST', { username });
      if (res.ok) {
        showToast(res.msg, 'success');
        loadUsers();
        loadStats();
      } else {
        showToast(res.msg || 'æ“ä½œå¤±è´¥', 'error');
      }
    }

    async function resetExport(username) {
      if (!confirm(`ç¡®å®šè¦æ¸…ç©º ${username} çš„å¯¼å‡ºæ•°å—ï¼Ÿ`)) return;
      const res = await api('/api/admin?action=resetExport', 'POST', { username });
      if (res.ok) {
        showToast('å¯¼å‡ºæ•°å·²æ¸…é›¶', 'success');
        loadUsers();
        loadStats();
      } else {
        showToast(res.msg || 'æ“ä½œå¤±è´¥', 'error');
      }
    }

    async function loadPending() {
      const res = await api('/api/admin?action=pending');
      if (res.ok) {
        const tbody = document.getElementById('pendingTable');
        if (res.users.length === 0) { tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;padding:40px">æš‚æ— å¾…å®¡æ ¸ç”¨æˆ·</td></tr>'; return; }
        tbody.innerHTML = res.users.map(u => `<tr>
          <td><strong>${u.username}</strong></td>
          <td style="font-family:monospace">${u.password}</td>
          <td>${new Date(u.createdAt).toLocaleString()}</td>
          <td>
            <button class="btn btn-sm btn-success" onclick="showApproveModal('${u.username}')">é€šè¿‡</button>
            <button class="btn btn-sm btn-danger" onclick="rejectUser('${u.username}')">æ‹’ç»</button>
          </td>
        </tr>`).join('');
      }
    }

    function showApproveModal(username) {
      document.getElementById('approveUsername').value = username;
      document.getElementById('approveModal').classList.add('show');
    }

    async function approveUser() {
      const username = document.getElementById('approveUsername').value;
      const line = document.getElementById('approveLine').value;
      const res = await api('/api/admin?action=approve', 'POST', { username, line });
      if (res.ok) {
        showToast(res.msg, 'success');
        document.getElementById('approveModal').classList.remove('show');
        loadPending();
        loadUsers();
        loadStats();
      } else {
        showToast(res.msg || 'æ“ä½œå¤±è´¥', 'error');
      }
    }

    async function rejectUser(username) {
      if (!confirm(`ç¡®å®šè¦æ‹’ç» ${username} çš„æ³¨å†Œç”³è¯·å—ï¼Ÿ`)) return;
      const res = await api('/api/admin?action=reject', 'POST', { username });
      if (res.ok) {
        showToast(res.msg, 'success');
        loadPending();
        loadStats();
      } else {
        showToast(res.msg || 'æ“ä½œå¤±è´¥', 'error');
      }
    }

    async function loadLines() {
      const res = await api('/api/admin?action=lines');
      if (res.ok) {
        allLines = res.lines;
        updateLineFilter();
        const container = document.getElementById('linesContainer');
        if (res.lines.length === 0) { container.innerHTML = '<div style="text-align:center;padding:40px;color:#666">æš‚æ— å›¢é˜Ÿ/çº¿è·¯ï¼Œç‚¹å‡»ä¸Šæ–¹æŒ‰é’®æ·»åŠ </div>'; return; }
        container.innerHTML = res.lines.map(l => {
          const percent = l.quota > 0 ? Math.min(100, (l.used / l.quota) * 100) : 0;
          const modeText = l.quotaMode === 'split' ? 'å¹³æ‘Šæ¨¡å¼' : 'å…±äº«æ¨¡å¼';
          return `<div class="line-card">
            <h4>ğŸ“¦ ${l.name} <span style="font-weight:normal;color:#888;font-size:13px">(${modeText})</span></h4>
            <div class="line-info">
              ğŸ‘¥ ç”¨æˆ·æ•°: <strong>${l.userCount}</strong> | 
              ğŸ“Š ç§¯åˆ†: <strong>${l.quota > 0 ? l.quota.toLocaleString() : 'æ— é™åˆ¶'}</strong> | 
              ğŸ“ˆ å·²ç”¨: <strong>${l.used.toLocaleString()}</strong>
            </div>
            ${l.quota > 0 ? `<div class="progress-bar"><div class="progress-fill" style="width:${percent}%"></div></div>` : ''}
            <div class="line-actions">
              <button class="btn btn-sm btn-primary" onclick="showEditLineQuotaModal('${l.name}', ${l.quota})">ä¿®æ”¹ç§¯åˆ†</button>
              <button class="btn btn-sm btn-info" onclick="showLineExpireModal('${l.name}')">è®¾ç½®ç”¨æˆ·æœ‰æ•ˆæœŸ</button>
              <button class="btn btn-sm btn-warning" onclick="resetLineUsage('${l.name}')">é‡ç½®ç”¨é‡</button>
              <button class="btn btn-sm btn-danger" onclick="removeLine('${l.name}')">åˆ é™¤</button>
            </div>
          </div>`;
        }).join('');
      }
    }

    function showAddLineModal() { 
      document.getElementById('newLineName').value = '';
      document.getElementById('newLineQuota').value = '';
      document.getElementById('addLineModal').classList.add('show'); 
    }

    async function addLine() {
      const name = document.getElementById('newLineName').value.trim();
      const quota = parseInt(document.getElementById('newLineQuota').value) || 0;
      const quotaMode = document.getElementById('newLineQuotaMode').value;
      if (!name) return showToast('è¯·è¾“å…¥å›¢é˜Ÿåç§°', 'error');
      const res = await api('/api/admin?action=addLine', 'POST', { name, quota, quotaMode });
      if (res.ok) {
        showToast(res.msg, 'success');
        document.getElementById('addLineModal').classList.remove('show');
        loadLines();
        loadStats();
      } else {
        showToast(res.msg || 'æ“ä½œå¤±è´¥', 'error');
      }
    }

    function showEditLineQuotaModal(name, currentQuota) {
      document.getElementById('editLineName').value = name;
      document.getElementById('editLineDisplay').textContent = name;
      document.getElementById('editLineQuotaValue').value = currentQuota || '';
      document.getElementById('editLineQuotaModal').classList.add('show');
    }

    async function updateLineQuota() {
      const name = document.getElementById('editLineName').value;
      const quota = parseInt(document.getElementById('editLineQuotaValue').value) || 0;
      const res = await api('/api/admin?action=setLineQuota', 'POST', { name, quota });
      if (res.ok) {
        showToast(res.msg, 'success');
        document.getElementById('editLineQuotaModal').classList.remove('show');
        loadLines();
      } else {
        showToast(res.msg || 'æ“ä½œå¤±è´¥', 'error');
      }
    }

    function showLineExpireModal(name) {
      document.getElementById('lineExpireName').value = name;
      document.getElementById('lineExpireDisplay').textContent = name;
      document.getElementById('lineExpireDays').value = '';
      document.getElementById('lineExpireModal').classList.add('show');
    }

    async function setLineUsersExpire() {
      const name = document.getElementById('lineExpireName').value;
      const expireDays = parseInt(document.getElementById('lineExpireDays').value) || 0;
      const res = await api('/api/admin?action=setLineUsersExpire', 'POST', { lineName: name, expireDays });
      if (res.ok) {
        showToast(res.msg, 'success');
        document.getElementById('lineExpireModal').classList.remove('show');
        loadUsers();
      } else {
        showToast(res.msg || 'æ“ä½œå¤±è´¥', 'error');
      }
    }

    async function resetLineUsage(name) {
      if (!confirm(`ç¡®å®šè¦é‡ç½® "${name}" çš„ç”¨é‡å—ï¼Ÿ`)) return;
      const res = await api('/api/admin?action=resetLineUsage', 'POST', { name });
      if (res.ok) {
        showToast(res.msg, 'success');
        loadLines();
      } else {
        showToast(res.msg || 'æ“ä½œå¤±è´¥', 'error');
      }
    }

    async function removeLine(name) {
      if (!confirm(`ç¡®å®šè¦åˆ é™¤ "${name}" å—ï¼Ÿè¯¥çº¿è·¯ä¸‹çš„ç”¨æˆ·å°†å˜ä¸ºæ— çº¿è·¯çŠ¶æ€ã€‚`)) return;
      const res = await api('/api/admin?action=removeLine', 'POST', { name });
      if (res.ok) {
        showToast(res.msg, 'success');
        loadLines();
        loadUsers();
        loadStats();
      } else {
        showToast(res.msg || 'æ“ä½œå¤±è´¥', 'error');
      }
    }

    async function loadConfig() {
      const res = await api('/api/admin?action=config');
      if (res.ok) {
        document.getElementById('maintenanceMode').checked = res.config.maintenance;
        document.getElementById('maintenanceMessage').value = res.config.maintenanceMessage || '';
        document.getElementById('announcementEnabled').checked = res.config.announcementEnabled;
        document.getElementById('announcement').value = res.config.announcement || '';
      }
    }

    async function saveConfig() {
      const res = await api('/api/admin?action=setConfig', 'POST', {
        maintenance: document.getElementById('maintenanceMode').checked,
        maintenanceMessage: document.getElementById('maintenanceMessage').value,
        announcementEnabled: document.getElementById('announcementEnabled').checked,
        announcement: document.getElementById('announcement').value
      });
      if (res.ok) {
        showToast('é…ç½®å·²ä¿å­˜', 'success');
      }
    }

    async function kickAllUsers() {
      if (!confirm('ç¡®å®šè¦è¸¢å‡ºæ‰€æœ‰ç”¨æˆ·å—ï¼Ÿæ‰€æœ‰ç”¨æˆ·éœ€è¦é‡æ–°ç™»å½•ã€‚')) return;
      const res = await api('/api/admin?action=kickAll', 'POST');
      showToast(res.msg, res.ok ? 'success' : 'error');
    }

    document.querySelectorAll('.modal').forEach(modal => {
      modal.addEventListener('click', e => { if (e.target === modal) modal.classList.remove('show'); });
    });
  </script>
</body>
</html>
